---
title: "Lactoferrin Isotope PCA"
author: "Aditya Singh"
date: "2025-12-07"
output: html_document
---

```{r}
# ============================================================
# 1) Setup: Load required packages
# ============================================================

library(tidyverse)   # data wrangling + pipes
library(readxl)      # read Excel files
library(ggplot2)     # plotting (also included in tidyverse)
library(lubridate)   # date handling (if needed later)
library(factoextra)  # PCA visualisations
```


```{r}
# ============================================================
# 2) Load dataset
# ============================================================

df <- read_xlsx("data/LACTOFERIN_SAMPLES.xlsx")

# Quick look at the dataset
glimpse(df)
```



```{r}
# ============================================================
# 3) Clean + prepare data for PCA
#    Goal: PCA on isotope ratios (d13C, d15N, d34S), coloured by Country
# ============================================================

# Keep only columns we need (helps avoid unexpected columns/issues)
df_clean <- df %>%
  select(`Sample`, `Date`, `Country`, `Weight mg`, d15N, d13C, d34S) %>%
  # Ensure correct data types
  mutate(
    Date = as.Date(Date),                 # or ymd(Date) if stored as text
    Country = as.factor(Country),
    `Weight mg` = as.numeric(`Weight mg`),
    d15N = as.numeric(d15N),
    d13C = as.numeric(d13C),
    d34S = as.numeric(d34S)
  )

# Filter out rows missing any isotope values needed for PCA
df_pca <- df_clean %>%
  filter(!is.na(d13C), !is.na(d15N), !is.na(d34S))
```



```{r}
# ============================================================
# 4) Scale isotope variables + run PCA
#    Scaling is important because variables can be on different ranges
# ============================================================

iso_data <- df_pca %>%
  select(d13C, d15N, d34S) %>%
  scale()

pca <- prcomp(iso_data)
```


```{r}
# ============================================================
# 5) Visualise PCA results (individuals)
#    - Colour points by Country
#    - Add confidence ellipses by group
# ============================================================

fviz_pca_ind(
  pca,
  geom.ind = "point",
  habillage = df_pca$Country,
  addEllipses = TRUE,
  legend.title = "Country of Origin"
)

```

```{r}
# ============================================================
# 6) Sanity checks
#    Ensure PCA rows match the label vector length
# ============================================================

nrow(pca$x)
length(df_pca$Country)

# check for missing Country labels
sum(is.na(df_pca$Country))
```


```{r}
# ============================================================
# 7) Results summary
#    - Variance explained by each principal component
#    - Loadings (which isotopes drive PC1/PC2 separation)
#    - Identify potential outliers using PCA distance in PC space
# ============================================================

# ---- 7.1 Variance explained ----
pca_var <- pca$sdev^2
pve <- pca_var / sum(pca_var)

variance_table <- tibble(
  PC = paste0("PC", seq_along(pve)),
  Variance_Explained = pve,
  Cumulative = cumsum(pve)
)

variance_table %>%
  mutate(across(c(Variance_Explained, Cumulative), ~ round(.x * 100, 2))) %>%
  rename(`Variance Explained (%)` = Variance_Explained,
         `Cumulative (%)` = Cumulative)

# Optional quick bar plot of variance explained
fviz_eig(pca, addlabels = TRUE)
```

The first principal component (PC1) explains 56.30% of the total variance in isotope values, while PC2 explains 27.76%.

Together, PC1 and PC2 account for 84.06% of total variance, indicating that a two-dimensional PCA representation captures the majority of the structure in the data.

This supports using the PC1â€“PC2 plot to assess clustering patterns by country of origin.

```{r}
# ---- 7.2 Loadings (Variable Contributions) ----
# PCA loadings indicate how strongly each isotope contributes
# to the principal components.

loadings <- as.data.frame(pca$rotation) %>%
  rownames_to_column("Variable")

loadings

# Visualise variable directions and contributions
# Arrow length reflects strength of contribution
# Angle between arrows reflects correlation structure
fviz_pca_var(pca, col.var = "contrib")
```

PC1 (56.3% variance explained) is primarily driven by opposing contributions from d13C (positive loading) and d34S (negative loading), suggesting these isotopes vary inversely across samples.

PC2 (27.8%) is strongly influenced by d15N, indicating nitrogen isotopic variation drives vertical separation in the PCA space.

The length of the vectors and their proximity to the unit circle indicate that the three isotope variables are well represented in the first two principal components.

Overall, the PCA suggests that carbon and sulfur isotopes are the dominant factors differentiating samples along PC1, while nitrogen variation contributes substantially to orthogonal separation.


From the PCA score plot:

Australian samples
- Form a tight, compact cluster.
- Exhibit low internal variability.
- Indicate a consistent isotopic fingerprint.
- The red ellipse represents ~95% confidence region for Australian samples.

New Zealand samples
- Separated from Australian samples primarily along PC2.
- Reflect distinct agricultural and environmental nitrogen and sulfur signatures.

United States samples
- Strongly separated along PC1.
- Show the most distinct isotopic profile among all groups.

Chinese samples
- Separated primarily along PC2.
- Do not overlap with the Australian confidence region.

The pilot sample labelled as Australian:
- Lies outside the Australian confidence ellipse.
- Does not cluster with confirmed Australian samples.
- Occupies a region of PCA space closer to non-Australian samples.

This indicates that the isotopic signature of the pilot sample is inconsistent with the established Australian reference group in this dataset



